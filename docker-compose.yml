services:
  # ==========================================
  # POSTGRES
  # ==========================================
  postgres:
    image: postgres:15
    container_name: moran-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      retries: 5
    networks:
      - moran-network

  # ==========================================
  # KAFKA (FIXED KRaft)
  # ==========================================
  kafka:
    image: apache/kafka:3.7.0
    container_name: moran-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LOG_DIRS: /var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "echo > /dev/tcp/localhost/9092"]
      interval: 15s
      retries: 10
    networks:
      - moran-network

  # ==========================================
  # API
  # ==========================================
  api:
    build: ./Backend
    container_name: moran-api
    volumes:
      - ./Backend:/app
      - ./Engine:/app/Engine
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "9000:8000"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      KAFKA_BROKER: kafka:9092
    networks:
      - moran-network

  # ==========================================
  # FRONTEND
  # ==========================================
  frontend:
    build:
      context: ./Frontend
      target: dev
    container_name: moran-frontend
    depends_on:
      api:
        condition: service_started
    ports:
      - "4000:4000"
    volumes:
      - ./Frontend:/app
      - /app/node_modules
    environment:
      NEXT_PUBLIC_API_URL: http://api:8000
    networks:
      - moran-network

  # ==========================================
  # REDIS
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: moran-redis
    networks:
      - moran-network

  # ==========================================
  # MARIADB
  # ==========================================
  mariadb:
    image: mariadb:10.6
    container_name: moran-mariadb
    environment:
      MYSQL_ROOT_PASSWORD: admin
      MYSQL_DATABASE: extra_db
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - moran-network

  # ==========================================
  # ERPNext
  # ==========================================
  erpnext:
    image: frappe/erpnext:v15.20.0
    platform: linux/amd64
    container_name: moran-erpnext
    depends_on:
      mariadb:
        condition: service_started
      redis:
        condition: service_started
    ports:
      - "9010:8000"
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    networks:
      - moran-network

  create-site:
    image: frappe/erpnext:v15.20.0
    platform: linux/amd64
    container_name: moran-site-creator
    depends_on:
      erpnext:
        condition: service_started
    entrypoint: ["/bin/bash", "-c"]
    command: |
      sleep 20
      echo '{"db_host":"mariadb","db_port":3306}' > sites/common_site_config.json
      if [ ! -d "sites/moran.localhost" ]; then
        bench new-site moran.localhost \
          --admin-password admin \
          --db-root-password admin \
          --install-app erpnext \
          --set-default
      fi
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    networks:
      - moran-network

networks:
  moran-network:
    driver: bridge

volumes:
  pg_data:
  mariadb_data:
  sites:
  logs:
